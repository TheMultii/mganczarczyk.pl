- pipeline: "Deploy"
  events:
  - type: "PUSH"
    refs:
    - "refs/heads/master"
  fail_on_prepare_env_warning: true
  resources: "SMALL"
  actions:
  - action: "bun install & build"
    type: "BUILD"
    docker_image_name: "oven/bun"
    docker_image_tag: "latest"
    execute_commands:
    - "bun i"
    - "bun run build"
    - "cd dist"
    shell: "BASH"
  - action: "ZIP build"
    type: "ZIP"
    local_path: "./dist"
    destination: "./build.zip"
  - action: "Transfer to mganczarczyk.pl"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "./build.zip"
    remote_path: "$release_www_dir"
    login: "$release_username"
    host: "mganczarczyk.pl"
    port: "$SSH_PORT"
    env_key: "secure!RrIlXAFZiScwKa/j21oSOIcj4ZNPNQAo4E7o9R3qs8I=.MaC0D91TuIaBWmD+gKQANQ=="
    authentication_mode: "ENV_KEY"
  - action: "[mganczarczyk.pl] Deploy"
    type: "SSH_COMMAND"
    working_directory: "$release_www_dir"
    login: "$release_username"
    host: "mganczarczyk.pl"
    port: "$SSH_PORT"
    env_key: "secure!RrIlXAFZiScwKa/j21oSOIcj4ZNPNQAo4E7o9R3qs8I=.MaC0D91TuIaBWmD+gKQANQ=="
    authentication_mode: "ENV_KEY"
    commands:
    - "find $release_www_dir -type f ! -name 'build.zip' -delete"
    - "unzip build.zip"
    - "cp $additional_files_dir/* ./ -R"
    - "chmod 755 * -R"
    - "rm build.zip"
    run_as_script: true
  - action: "Run mganczarczyk-pl/Deploy Beta"
    type: "RUN_NEXT_PIPELINE"
    comment: "Triggered by $BUDDY_PIPELINE_NAME execution #$BUDDY_EXECUTION_ID"
    priority: "NORMAL"
    variables:
    - key: "branch"
      value: "master"
      type: "VAR"
    next_project_name: "mganczarczyk-pl"
    next_pipeline_name: "Deploy Beta"
