- pipeline: "Deploy Beta"
  events:
  - type: "PUSH"
    refs:
    - "refs/heads/dev"
  fail_on_prepare_env_warning: true
  resources: "SMALL"
  actions:
  - action: "Checkout master"
    type: "BUILD"
    docker_image_name: "library/ubuntu"
    docker_image_tag: "20.04"
    execute_commands:
    - "[ \"$branch\" = \"master\" ] && apt-get update && apt-get install git -y && git checkout master || true"
    shell: "BASH"
  - action: "bun install & build"
    type: "BUILD"
    docker_image_name: "oven/bun"
    docker_image_tag: "latest"
    execute_commands:
    - "[ \"$branch\" = \"master\" ] && git checkout master"
    - "bun i"
    - "bun run build"
    - "cd dist"
    shell: "BASH"
  - action: "ZIP build"
    type: "ZIP"
    local_path: "./dist"
    destination: "./build-beta.zip"
  - action: "Transfer to mganczarczyk.pl"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "build-beta.zip"
    remote_path: "$beta_www_dir"
    login: "$release_username"
    host: "mganczarczyk.pl"
    port: "$SSH_PORT"
    env_key: "secure!RrIlXAFZiScwKa/j21oSOIcj4ZNPNQAo4E7o9R3qs8I=.MaC0D91TuIaBWmD+gKQANQ=="
    authentication_mode: "ENV_KEY"
  - action: "[mganczarczyk.pl] Deploy Beta"
    type: "SSH_COMMAND"
    working_directory: "$beta_www_dir"
    login: "$release_username"
    host: "mganczarczyk.pl"
    port: "$SSH_PORT"
    env_key: "secure!RrIlXAFZiScwKa/j21oSOIcj4ZNPNQAo4E7o9R3qs8I=.MaC0D91TuIaBWmD+gKQANQ=="
    authentication_mode: "ENV_KEY"
    commands:
    - "find $beta_www_dir -type f ! -name 'build-beta.zip' -delete"
    - "unzip build-beta.zip"
    - "chmod 755 * -R"
    - "rm build-beta.zip"
    run_as_script: true
